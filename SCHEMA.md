# JSON Schema Documentation

This document describes the two data files generated by the Python scripts and consumed by the React website.

---

## File 1: leagueData.json

Generated by `scripts/fetch_league_data.py`. Contains all match data, registrations, and leaderboards.

### Root Object

```typescript
{
  lastUpdated: string,           // ISO 8601 timestamp (UTC)
  leagues: {
    [leagueName: string]: League
  },
  globalLeaderboard: Player[]
}
```

### Types

#### League

```typescript
{
  subLeagues: {
    [subLeagueName: string]: SubLeague
  }
}
```

#### SubLeague

```typescript
{
  rounds: Round[],
  leaderboard: Player[],
  record?: { wins: number, losses: number, draws: number }
}
```

#### Round

```typescript
{
  round?: string | null,             // e.g. "R1", "NA" (auto-assigned), or null
  status: "open" | "in_progress" | "finished",
  matchId: string,                   // API identifier
  matchUrl: string,                  // API URL
  matchWebUrl?: string,              // Web-friendly URL
  name: string,                      // Original match title
  startTime?: number | null,         // Unix seconds
  endTime?: number | null,           // Unix seconds
  boards: number,                    // Number of boards
  matchResult: {
    ourScore: number,
    opponentScore: number,
    result: "win" | "lose" | "draw" | "forfeit" | "double forfeit" | "win by forfeit" | "unknown"
  },
  playerStats: {
    [username: string]: {
      games: number,
      wins: number,
      draws: number,
      losses: number
    }
  },

  // For open matches with registration data
  registrationData?: {
    type: "roster",
    ourRoster: { username: string, rating?: number }[],
    oppRoster: { username: string, rating?: number }[]
  } | null,

  // For open matches with board assignments
  boardsData?: {
    boardNumber: number,
    ourPlayer?: string,
    ourRating?: number | null,
    oppPlayer?: string,
    oppRating?: number | null,
    ratingDiff?: number | null
  }[],

  registeredPlayers?: { our: number, opponent: number },
  minTeamPlayers?: number            // Minimum players required
}
```

#### Player (in leaderboard)

```typescript
{
  username: string,
  games: number,
  wins: number,
  draws: number,
  losses: number,
  points?: number                    // Calculated: wins + 0.5 * draws
}
```

### Key Features

- **Status**: Open (registration), In Progress (playing), or Finished
- **Forfeit Detection**: Automatic for completed matches (0-0 score)
- **Registration Data**: Rosters and board assignments for upcoming matches
- **Leaderboards**: Sorted by points (desc), then games (asc)

---

## File 2: timeoutData.json

Generated by `scripts/enrich_timeouts.py`. Contains timeout risk analysis for players registered in open matches.

### Root Object

```typescript
{
  generatedAt: string,               // ISO 8601 timestamp (UTC)
  riskThresholdPercent: number,      // Timeout % threshold (currently 25.0)
  players: {
    [username: string]: PlayerRisk
  }
}
```

### Types

#### PlayerRisk

```typescript
{
  timeoutPercent: number | null,     // Overall timeout %, from Chess.com stats
  dailyRating: number | null,        // Current 1-day chess rating
  rating960: number | null,          // Current Chess960 rating
  totalLeagueTimeouts90Days: number, // Timeouts in league matches (last 90 days)
  subLeagueTimeouts: {
    [league: string]: {
      [subLeague: string]: number    // Timeouts per sub-league (all-time)
    }
  },
  dailyTimeouts: {
    1day: { count: number, lastTimeoutDate: string | null },
    2day: { count: number, lastTimeoutDate: string | null },
    3day: { count: number, lastTimeoutDate: string | null }
  },
  riskFlag: boolean,                 // True if timeoutPercent > threshold
  riskLevel: "HIGH" | "MEDIUM" | "LOW" | null,  // Risk tier (null if not flagged)
  riskReason: string | null          // Human-readable explanation
}
```

### Risk Levels

- **HIGH**: High timeout % with recent league or daily timeouts
- **MEDIUM**: Moderate risk or historical pattern
- **LOW**: Timeout % exceeds threshold but minimal recent activity
- **null**: No risk flag (timeoutPercent â‰¤ 25%)

### Data Collection

- **Player registration**: Scans `status == "open"` rounds in `leagueData.json`
- **Player roster**: Reads `registrationData.ourRoster` (registered for upcoming match)
- **Chess.com API**: Fetches player stats and game archives for timeout history
- **Coverage**: Only includes unique players across open matches

---

## Examples

### leagueData.json snippet (open match)

```json
{
  "round": null,
  "status": "open",
  "name": "Chess960 WL2026 R2: Team Bulgaria vs Team USA",
  "startTime": 1772323200,
  "boards": 11,
  "registrationData": {
    "type": "roster",
    "ourRoster": [
      { "username": "mattdune", "rating": 1595 },
      { "username": "cuttingtiles", "rating": 1799 }
    ],
    "oppRoster": [
      { "username": "mirchevvh", "rating": 1662 }
    ]
  },
  "registeredPlayers": { "our": 44, "opponent": 11 },
  "minTeamPlayers": 60,
  "playerStats": {}
}
```

### timeoutData.json snippet

```json
{
  "generatedAt": "2026-02-20T01:42:19Z",
  "riskThresholdPercent": 25.0,
  "players": {
    "luddwigg": {
      "timeoutPercent": 29.0,
      "dailyRating": 1271,
      "rating960": 1428,
      "totalLeagueTimeouts90Days": 0,
      "subLeagueTimeouts": {},
      "dailyTimeouts": {
        "1day": { "count": 0, "lastTimeoutDate": null },
        "2day": { "count": 0, "lastTimeoutDate": null },
        "3day": { "count": 7, "lastTimeoutDate": "2026-01-15" }
      },
      "riskFlag": true,
      "riskLevel": "LOW",
      "riskReason": "Low risk: timeout ratio 29%, no recent sub-league timeouts, only 7 recent daily timeout(s)."
    }
  }
}
```

---

## Integration Notes

- **UI**: React components read both files to show registration warnings and timeout alerts
- **Refresh Cycle**: Both files updated nightly by GitHub Actions
- **Frontend**: Completely static (no backend API calls after initial JSON load)
# JSON Schema for League Data

This document describes the actual structure of `leagueData.json` produced by `scripts/fetch_league_data.py` and consumed by the React UI. It includes fields for match metadata, results (including forfeit detection), registration information, and board-level rating data.

## Root Object

```typescript
{
  lastUpdated: string,           // ISO 8601 timestamp (UTC)
  leagues: {
    [leagueName: string]: League
  },
  globalLeaderboard: Player[]
}
```

## Types

### League

```typescript
{
  subLeagues: {
    [subLeagueName: string]: SubLeague
  }
}
```

### SubLeague

```typescript
{
  rounds: Round[],
  leaderboard: Player[],
  record?: { wins: number, losses: number, draws: number }
}
```

### Round

```typescript
{
  round?: string | null,             // e.g. "R1" or auto-assigned "R3"; may be null initially
  status: "open" | "in_progress" | "finished",
  matchId: string,                   // API identifier (often full API URL)
  matchUrl: string,                  // API URL
  matchWebUrl?: string,              // Web-friendly URL (https://www.chess.com/club/matches/{id})
  name: string,                      // Original match title
  startTime?: number | null,         // Unix seconds (may be null)
  endTime?: number | null,           // Unix seconds (may be null)
  boards: number,                    // Number of boards in the match
  matchResult: {
    ourScore: number,
    opponentScore: number,
    result: "win" | "lose" | "draw" | "forfeit" | "double forfeit" | "win by forfeit" | "unknown"
  },
  playerStats: {
    [username: string]: {
      games: number,
      wins: number,
      draws: number,
      losses: number
    }
  },

  // Registration-related fields (present for registration/open matches)
  registrationData?: {
    // If boards are not yet assigned this will be a roster object
    type: "roster",
    ourRoster: { username: string, rating?: number }[],
    oppRoster: { username: string, rating?: number }[]
  } | null,

  // If boards are assigned, boardsData is an array of per-board objects
  boardsData?: {
    boardNumber: number,
    ourPlayer?: string,
    ourRating?: number | null,
    oppPlayer?: string,
    oppRating?: number | null,
    ratingDiff?: number | null
  }[],

  registeredPlayers?: { our: number, opponent: number },
  minTeamPlayers?: number  // Present for all matches, extracted from match settings
}
```

### Player

```typescript
{
  username: string,
  games: number,
  wins: number,
  draws: number,
  losses: number,
  points?: number
}
```

## Additional Notes

- `matchId` and `matchUrl` are often full API URLs (e.g. `https://api.chess.com/pub/match/1895389`). `matchWebUrl` is provided for convenient linking to the chess.com UI.
- `round` may be parsed from the match title (e.g. `R1`) or auto-assigned by the script when the title looks like a team matchup (e.g. `Team A vs Team B`). Auto-numbered rounds are set to `R{n}`.
- `registrationData` is present for `open` matches; if boards are not assigned it provides sorted rosters for strategic planning. If boards are assigned `boardsData` will be an array with ratings per board.
- `registeredPlayers` provides simple counts used by the UI to show registration progress.
- `minTeamPlayers` is extracted from match settings and available for all matches (not just registration). Used for forfeit detection.
- `playerStats` contains only stats aggregated from matches where our club's players participated (the script filters to our club when building per-player stats).

### Forfeit Detection

For **finished** matches with a 0-0 score, the script automatically detects forfeits based on player counts vs. `minTeamPlayers`:
- **"forfeit"**: We failed to meet minimum players (we lose)
- **"double forfeit"**: Both teams failed to meet minimum (we lose)
- **"win by forfeit"**: Opponent failed to meet minimum (we win)

This only applies to completed matches and does not affect registration warnings for open matches.

### Timeout Tracking

The script tracks timeout data from the Chess.com API in two ways:

1. **For in_progress/finished matches**: Counts games where a player timed out by checking the game result (`"timeout"` value in `played_as_white` or `played_as_black`). These are tracked in the `timeouts` field and also count toward `losses`. Only included in the output if the count is greater than 0.

2. **For open matches**: Extracts the `timeout_percent` value from each player object during registration. This represents the player's timeout percentage over the last 90 days according to Chess.com's data. This field is always populated for players in open matches.

These fields help identify reliability issues and timeout risks when evaluating match rosters.

## Examples

Partial example of a finished round:

```json
{
  "round": "R3",
  "status": "finished",
  "matchId": "https://api.chess.com/pub/match/1895389",
  "matchUrl": "https://api.chess.com/pub/match/1895389",
  "matchWebUrl": "https://www.chess.com/club/matches/1895389",
  "name": "1WL summer league R3: 1 day per move club vs I like beer",
  "startTime": 1769328243,
  "endTime": 1771258083,
  "boards": 4,
  "matchResult": { "ourScore": 5, "opponentScore": 3, "result": "win" },
  "playerStats": {
    "engelleik": { "games": 2, "wins": 2, "draws": 0, "losses": 0 },
    "player2": { "games": 3, "wins": 1, "draws": 0, "losses": 2, "timeouts": 2 }
  }
}
```

Partial example of an open registration match with roster data:

```json
{
  "round": null,
  "status": "open",
  "matchId": "https://api.chess.com/pub/match/1895427",
  "matchUrl": "https://api.chess.com/pub/match/1895427",
  "name": "1WL ...: 1 day per move club vs Africa Chess Group",
  "startTime": 1769328244,
  "boards": 7,
  "registrationData": {
    "type": "roster",
    "ourRoster": [ { "username": "legit_chess411", "rating": 1500 } ],
    "oppRoster": [ { "username": "opponent1", "rating": 1480 } ]
  },
  "registeredPlayers": { "our": 6, "opponent": 7 },
  "minTeamPlayers": 8,
  "playerStats": {
    "legit_chess411": { "games": 0, "wins": 0, "draws": 0, "losses": 0, "timeout_percent": 15 },
    "opponent1": { "games": 0, "wins": 0, "draws": 0, "losses": 0, "timeout_percent": 0 }
  }
}
```

Partial example of an open registration match with board assignments:

```json
{
  "status": "open",
  "boards": 6,
  "boardsData": [
    { "boardNumber": 1, "ourPlayer": "alice", "ourRating": 1600, "oppPlayer": "bob", "oppRating": 1550, "ratingDiff": 50 }
  ],
  "registeredPlayers": { "our": 6, "opponent": 6 }
}
```

## Sorting & Calculations

- Leaderboards are computed by summing `wins` + 0.5 * `draws` into `points` and sorted by points (desc) then games (asc).
- Sub-league `record` is derived from `matchResult.result` values across rounds.

## Migration / Compatibility

If you adapt the script for another club or change `LEAGUE_PREFIXES`, ensure your match titles place the league prefix first and follow a consistent pattern so the `parse_match_title` logic can extract `league`, `subLeague`, and `round` as intended.
